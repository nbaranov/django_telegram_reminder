{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
    <style>
        .completed { text-decoration: line-through; color: #6c757d; }
        .pending { }
        .status-badge { font-size: 0.8em; }
    </style>
{% endblock %}

{% block content %}
    <h2>Напоминания (Vue)</h2>
    <div id="reminders-app">
        <div v-if="loading" class="alert alert-info">Загрузка...</div>
        <div v-if="error" class="alert alert-danger">[[ error ]]</div>

        <div v-if="!loading">
            <div class="row mb-3">
                <div class="col-md-6">
                    <input v-model="filterText" type="text" class="form-control" placeholder="Поиск по тексту...">
                </div>
                <div class="col-md-6">
                    <select v-model="filterCompleted" class="form-select">
                        <option value="all">Все статусы</option>
                        <option value="pending">В ожидании</option>
                        <option value="completed">Выполнено</option>
                    </select>
                </div>
            </div>

            <button @click="createReminder" class="btn btn-success mb-3">Добавить (Django)</button>

            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Текст</th>
                        <th>Группы</th>
                        <th>Время</th>
                        <th>Статус</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="reminder in filteredReminders" :key="reminder.id">
                        <td>[[ reminder.id ]]</td>
                        <td v-if="!editingReminder || editingReminder.id !== reminder.id" :class="{ 'completed': reminder.is_completed, 'pending': !reminder.is_completed }">
                            [[ reminder.text ]]
                        </td>
                        <td v-else>
                            <input v-model="editingReminder.text" type="text" class="form-control">
                        </td>
                        <td v-if="!editingReminder || editingReminder.id !== reminder.id">
                            <span v-for="group in reminder.groups" :key="group.id" class="badge bg-info me-1">[[ group.name ]]</span>
                        </td>
                        <td v-else>
                            <select v-model="editingGroups" multiple class="form-select">
                                <option v-for="group in groups" :key="group.id" :value="group.id">[[ group.name ]]</option>
                            </select>
                        </td>
                        <td v-if="!editingReminder || editingReminder.id !== reminder.id">[[ formatDate(reminder.due_time) ]]</td>
                        <td v-else>
                            <input v-model="editingReminder.due_time" type="datetime-local" class="form-control">
                        </td>
                        <td v-if="!editingReminder || editingReminder.id !== reminder.id">
                            <span :class="['badge', 'status-badge', statusBadgeClass(reminder.is_completed)]">[[ reminder.is_completed ? statusLabels.completed : statusLabels.pending ]]</span>
                        </td>
                        <td v-else>
                            <input type="checkbox" v-model="editingReminder.is_completed">
                        </td>
                        <td>
                            <div v-if="!editingReminder || editingReminder.id !== reminder.id">
                                <button @click="toggleCompleted(reminder)" class="btn btn-sm" :class="reminder.is_completed ? 'btn-warning' : 'btn-success'">
                                    [[ reminder.is_completed ? 'Отменить' : 'Выполнено' ]]
                                </button>
                                <button @click="startEditing(reminder)" class="btn btn-sm btn-primary">Редактировать</button>
                                <button @click="deleteReminder(reminder)" class="btn btn-sm btn-danger">Удалить</button> <!-- Передаём объект -->
                            </div>
                            <div v-else>
                                <button @click="saveEditing" class="btn btn-sm btn-success">Сохранить</button>
                                <button @click="cancelEditing" class="btn btn-sm btn-secondary">Отмена</button>
                            </div>
                        </td>
                    </tr>
                    <tr v-if="filteredReminders.length === 0">
                        <td colspan="6">Напоминаний не найдено.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script src="{% static 'reminders/js/vue.global.prod.js' %}"></script>
    <script>
        // Формируем базы из существующих URL, убирая ID
        const updateUrlExample = "{% url 'api_update_reminder' pk=12345 %}";
        const deleteUrlExample = "{% url 'api_delete_reminder' pk=12345 %}";

        window.REMINDERS_DATA = {
            remindersApiEndpoint: "{% url 'api_reminders' %}",
            groupsApiEndpoint: "{% url 'api_groups' %}",
            updateReminderBaseUrl: updateUrlExample.replace('12345/', ''), // Получаем базу /api/reminders/
            deleteReminderBaseUrl: deleteUrlExample.replace('12345/', ''), // Получаем базу /api/reminders/delete/
            csrfToken: "{{ csrf_token }}"
        };
    </script>
    <script type="module" src="{% static 'reminders/js/reminders_app.js' %}"></script>
{% endblock %}